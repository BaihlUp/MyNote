---
title: 深入浅出云计算
date: 2024-03-10
categories:
  - 虚拟化&云计算
tags:
  - 云计算
published: false
---
# 1 IaaS篇
## 1.1 区域和可用区
云厂商在选址时一般会有两种思路：
1. 一种是考虑放在人口稠密的中心城市，离用户和商业更近，以提高较快的接入体验。
2. 另一种是在相对偏远的地区，当地往往能够提供良好的气候条件、充足的建设空间，以及较低的电力、带宽等运营维护成本。

- **总结**

1. 区域是云计算的顶层概念，云服务以区域为单位对外开放；
2. 区域选择需要考虑多种因素，包括但不限于地理位置、服务丰富性、开服时间、资源成本、可用区数量等；
3. 可用区是区域之下的重要层级，代表独立的数据中心，一个区域内往往有多个可用区；
4. 妥善将资源分布到不同可用区，可实现故障隔离，提高架构的可用性。

## 1.2 云虚拟机
### 1.2.1 云虚拟机到底是什么？
云虚拟机的体系结构，用一句话来概括一下，就是全面解耦的计算存储分离的设计思想。
传统的虚拟化，往往是对单一物理机器资源的纵向切割，计算、存储、网络等各方面的能力都是一台物理机的子集。因此，从可伸缩性的角度来说，传统虚拟机存在较大的局限，当物理机的局部出现故障时，也很容易影响到里面的虚拟机。
得益于云端大规模的专属硬件以及高速的内部网络，云虚拟机的组成则有所不同。除了核心的CPU与内存部分仍属于一台宿主机外，它的网络、硬盘等其他部分，则可以超脱于宿主机之外，享受云端其他基础设施的能力。大致架构如下图所示：
![](https://raw.githubusercontent.com/BaihlUp/Figurebed/master/2024/20240310175356.png)
你要注意的是，这里我所给出的仅仅是一个简化加工之后的示意图。实际的云计算内部实现，会远比这个要复杂和精妙。不同的云的内部，也会有许多不同的专用硬件各显神通。
虽然各个云厂商对云虚拟机有不同的叫法，但它们的产品形态是比较一致的。当你来到虚拟机服务的门户，一般会有一个列表界面，能够列出当前你拥有的所有虚拟机，你可以按照不同字段过滤、删选、排序。你还可以点击某个VM查看详情，界面一般会展示出VM的常用运行指标。
![](https://raw.githubusercontent.com/BaihlUp/Figurebed/master/2024/20240310175423.png)

### 1.2.2 云端“攒机”实战
在云计算厂商哪儿创建虚拟机，可在网上找相应教程

### 1.2.3 如何选择虚拟机型号

* 云虚拟机的配置规格主要取决于类型、代别、实例大小三个最重要的维度。
* 实例所属的类型，决定了虚拟机相应的硬件资源配比与专项能力，分别为不同的场景优化设计。你可以根据实际场景来酌情选用，这样既能满足需求又好控制成本。
* 云虚拟机的型号名称一般由类型、代别、实例大小这几项的缩写组合而成，有时还会带有补充后缀。了解了某个云的型号格式后，通过拆分对应，你很容易理解具体型号的含义。

### 1.2.4 省钱妙招
- 省钱妙招之一：使用包年包月机型

包年包月的付费方式是最常见的降低虚拟机使用成本的方法，它通过牺牲采购的灵活性来换取折扣。

- 省钱妙招之二：使用竞价实例

竞价实例，是AWS所首创的产品形式，其他的云厂商近几年也在纷纷跟进。它的基本原理是，**把云数据中心上闲置的机器资源拿出来，进行公开的拍卖，价高者得**。让“市场机制”，也就是各个用户，来主导这些闲置资源的定价。
竞价实例的机制让云端的闲置资源对外开放，基于市场竞拍的定价方式，常常能够让我们获得很大的折扣。这种方法主要是通过牺牲稳定性，来换取成本上的节约。

- 省钱妙招之三：使用突发性能机型

是一种特殊的使用CPU积分制的机型，相对标准机型成本较低，适合工作负载存在较大波动的场景。它主要牺牲的是性能。

- 省钱妙招之四：使用ARM实例

基于ARM的虚拟机实例已陆续走向市场，随着生态的不断成熟，也将成为低成本机型中非常具有竞争力的选择。这种方法主要在生态和兼容性方面存在一些限制。


## 1.3 云硬盘

* 云硬盘是云虚拟机的主要持久化存储，与宿主机往往是分离的；
* 云硬盘支持动态添加和删除，使用起来灵活方便；
* 云硬盘一般提供多种性能等级，最终性能会受存储介质和容量大小的共同影响；
* 部分虚拟机型号会自带高性能的本地磁盘，在可以容忍数据丢失风险时，是你值得考虑的一个选择。

云硬盘的付费模式，同样有按量付费和包年包月之分。在很多的云上，你能够为一块云盘启用包年，长期租用的确定性也能够给你带来折扣，这和虚拟机资源的包年包月是一样的。

## 1.4 云上虚拟网络
### 1.4.1 虚拟私有网络
虚拟私有网络（Virtual Private Cloud，简称VPC），是云计算网络端最重要的概念之一，它是指构建在云上的、相互隔离的、用户可以自主控制的私有网络环境。虚拟私有网络有时也称为专有网络（阿里云）或虚拟网络（Virtual Network或VNet，Azure的叫法）。
私有网络就是一张属于你自己的内网。内网之内的服务器和设备，可以比较自由地互相通信，与外界默认是隔离的。如果外部互联网，或者其他虚拟网络需要连接，则需要额外的配置。

在传统数据中心里，经典网络架构中的概念和组件，在虚拟网络中你几乎都能找到对应。这里比较重要的一些概念包括：

* 网段，私有网络的内部IP区段，通常用CIDR形式来表达，如192.168.0.0/16。
* 子网，私有网络的下级网络结构，一个私有网络可以划分多个子网，这和通常意义上的子网也是对应和一致的。阿里云中把子网形象地称为“交换机”。
* 路由表，用于定义私有网络内流量的路由规则，决定着数据包的“下一跳”去向何方。每个子网都必须有一张关联的路由表，通常情况下，系统会自动帮你创建一个默认的路由表。
* 网关，是对进出私有网络的流量进行把守和分发的重要节点，根据用途的不同，有多种类型，后面我们还会讲到。
* 安全组，私有网络里虚拟机进出流量的通行或拦截规则，可以起到虚拟机网络防火墙的作用。

### 1.4.2 私有网络中的虚拟机
当一个虚拟网络已经存在时，我们就可以将新创建的虚拟机放置在这个虚拟网络中。
虚拟机中可以创建网卡，称为弹性网卡（Elastic Network Interface， 简称ENI）。虚拟机的网卡一方面是和虚拟机的本体进行绑定，另一方面则嵌入某个私有网络的子网，也会拥有至少一个私网IP。
云上的网卡，之所以被称为“弹性”网卡，是因为它具备以下特征：

1. 一个虚拟机可以绑定多块网卡，有主网卡和辅助网卡之分；
2. 一块网卡隶属于一个子网，可以配置同一子网内的多个私有IP；
3. 辅助网卡可以动态解绑，还能够绑定到另一台虚拟机上。

当你在创建虚拟机的时候，向导会询问你，这台虚拟机属于哪个VPC，以及VPC下的哪个子网？这个选项的实质性结果，就是新虚拟机自动生成的主网卡，接入了所选VPC的所选子网。

在创建虚拟机时，不建议使用自动生成的公网IP，因为公网IP是随机分配的，在重启后IP可能就变了。
建议使用弹性公网IP（Elastic IP），有些云称为eIP。弹性IP一旦生成，它所对应的IP是固定、不会变化的，而且完全属于你所有。这非常适合需要稳定IP的生产环境。

它所谓的弹性，其实是指可以非常自由地解绑和再次绑定到任意目标。你本质上是买下了这个IP的所有权，将这个IP赋予谁，是你的权利，而且你还可以动态按需切换。
![](https://raw.githubusercontent.com/BaihlUp/Figurebed/master/2024/BCB81DE2-FE68-4B55-96A1-31AE3B8BAF0F.jpg)

![](https://raw.githubusercontent.com/BaihlUp/Figurebed/master/2024/EC708BF0-86D8-43AC-A02E-BC1469BDE684.jpg)
绑定之后，就自然可以连上刚才的这台虚拟机了。注意VM列表界面会有相应的显示：
![](https://raw.githubusercontent.com/BaihlUp/Figurebed/master/2024/7002C6DA-57F7-4013-A600-118B89A81693.jpg)

拥有了弹性公网IP后，可以在任何地方，直接ssh连接。

### 1.4.3 网关、VPN
上边为虚拟机分配弹性IP可以对外访问，但是虚拟机很多的情况下就不适合了，此时可以使用网关。

创建一个NAT网关实例，并选择它对应的VPC，然后把弹性IP(47.102.139.39)绑定到NAT网关上：
![](https://raw.githubusercontent.com/BaihlUp/Figurebed/master/2024/D2CF3DBD-83EF-498E-86DE-64F8003F3AF9.jpg)
这里的关键之处在于接下来我们要添加的SNAT条目。

SNAT是“源地址转换”的意思，它非常适合让私有网络的主机共享某个公网IP地址接入Internet。注意，这是一种从内向外的、单向的连通形式。
![](https://raw.githubusercontent.com/BaihlUp/Figurebed/master/2024/1EF7C7F0-EC2B-45B7-A63F-992069173D73.jpg)
上面我们添加了一个SNAT条目，让整个交换机“test-vpc1-vsw2”下的网段都共享一个出口公网IP。你要注意，我们的虚拟机是位于这个网段内的。

还有一种网关被称为VPN网关，也可以帮助外界连接到VPC，它本质上是基于你所熟知的VPN技术。由于VPN能够基于互联网提供私有加密的通信，因此非常适合用来从任意其他私有设施安全地连接到VPC。这些私有设施可以小到一台个人电脑或手机终端，也可以大到是你本地的数据中心，还可以是另一个VPC。

### 1.4.4 多网连接的方式
公有云上是允许你同时使用多个VPC的，这样你可以构建更加复杂的网络架构，实现模块隔离和跨区域扩展等高级需求。

如果是云端VPC和VPC的互联，我首先推荐的就是对等连接（VPC Peering）的方式。它能够在不添加额外设备的情况下，让两个VPC无缝地互联起来，而且操作非常简单，对等连接甚至还能够支持跨区域的私有网络互联。当然，对等连接的实施前提，是这两个VPC的网段没有交集，不存在冲突。
这里你需要注意对等连接的一个特点，就是它不具备传递性。也就是说，如果A和B建立了对等连接，B和C建立了对等连接，那么A和C是不相通的。这是对等连接的一个局限。
如果你真的需要多个VPC间任意路径的互联互通，那么可以考虑使用比对等连接更为复杂和强大的专用网络设施，比如AWS的Transit Gateway，和阿里云的云企业网，它们能够帮助搭建更为复杂的多VPC网络拓扑结构，也允许进行更精细的路由设置。如有需要，建议你仔细阅读厂商的文档进行学习和研究。
公有云中的私有网络，还可以和企业本地数据中心进行互联，形成混合云架构。
## 1.5 云端架构最佳实践
### 1.5.1 面对故障，提升冗余
1. 第一种故障是在宿主机的级别，这也是从概率上来说最常见的一种故障。

我们需要保证多个虚拟机不在同一台宿主机上，甚至不处于同一个机架上，以免这些虚拟机一起受到局部事故的影响。


2. 第二种规模更大的故障，是在数据中心，也就是可用区的层面。比如火灾、雷击等意外。


3. 第三种更严重的故障，就是整个区域级别的事故了。

> 为了应对故障可以实行服务多区域部署，防止某地域机房故障，也可以使用多云，防止某家云厂商出现故障。


### 1.5.2 弹性伸缩
可以尝试使用弹性伸缩服务来实现云端弹性架构，用它来管理一组虚拟机，并与负载均衡一起配合。这特别适合处理无状态类的计算需求，因为它会为你代劳底层计算资源的管理。

比如阿里云，可以使用弹性伸缩，然后配合负载均衡器。自定义一组虚拟机数量提供服务，然后配置规则，在负载增大时，弹性伸缩为增加虚拟机数量提供服务，负载均衡也能够自动识别，将流量分发到新创建的虚拟机上。当负载减小，则会减少虚拟机的数量。


## 1.6 云上运维
首先，在云端，传统的运维工作仍然存在，其中包括你所熟知的监控、部署、升级、备份等等。
其次，你的运维工作中很可能包含迁移。
再次，云上的运维会包含和云厂商进行对接的工作。
最后，云上运维会具有很强的管理属性。
所以，高明的云上运维，既要为应用开发赋能，要足够高效，也要有适当的管理和约束。我们团队的组织架构和分工，最好也能够配合和适应这个需要。


# 2 PaaS篇

## 2.1 什么是PaaS
IAAS主要是侧重于基础设施类的云服务，尤其是虚拟机、云磁盘、云网络等服务。它们的特点是，和传统IT基础设施往往有一个对应关系，所以被称为基础设施即服务（Infrastructure-as-a-Service）。

PaaS （Platform-as-a-Service），则是指云计算提供的平台类服务，在这些平台的基础上，用户可以直接开发、运行、管理应用程序，而无需构建和维护底层的基础设施。

用更通俗的话来说，PaaS是在IaaS的基础上又做了许多工作，构建了很多关键抽象和可复用的单元，让我们用户能够在更上层进行应用的构建，把更多精力放在业务逻辑上。

> PaaS本身也是基于底层IaaS构建出来的，使用了云上的各种基础设施。只是这个步骤云服务提供商代替我们用户完成了，还进行了一定程度的封装。



## 2.2 对象存储

## 2.3 应用托管服务

## 2.4 云数据库

## 2.5 云上大数据

## 2.6 云上容器服务

## 2.7 无服务器计算

## 2.8 云上AI服务







